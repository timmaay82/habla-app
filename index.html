<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Habla Espa√±ol</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { color: #333; }
    #chat { background: white; padding: 15px; border-radius: 8px; height: 400px; overflow-y: auto; margin-bottom: 15px; }
    .msg-user { color: blue; margin: 5px 0; }
    .msg-ai { color: green; margin: 5px 0; }
    button { padding: 10px 15px; font-size: 16px; margin: 5px; }
    input, select { padding: 8px; margin: 5px 0 15px 0; width: 100%; }
  </style>
</head>
<body>
  <h1>üá™üá∏ Habla Espa√±ol</h1>

  <p>Enter your OpenAI API key:</p>
  <input type="password" id="apiKey" placeholder="sk-...">

  <p>Select a roleplay mode:</p>
  <select id="mode">
    <option value="free">üó£Ô∏è Free Chat</option>
    <option value="restaurant">üçΩÔ∏è Restaurant</option>
    <option value="hotel">üè® Hotel</option>
    <option value="airport">‚úàÔ∏è Airport</option>
  </select>

  <div id="chat"></div>

  <button id="micBtn" onclick="toggleRecording()">üé§ Speak</button>

  <script>
  let mediaRecorder;
  let audioChunks = [];
  let isRecording = false;

  function addMessage(sender, text) {
    const chat = document.getElementById("chat");
    const p = document.createElement("p");
    p.className = sender === "user" ? "msg-user" : "msg-ai";
    p.textContent = (sender === "user" ? "üó£Ô∏è T√∫: " : "ü§ñ AI: ") + text;
    chat.appendChild(p);
    chat.scrollTop = chat.scrollHeight;
  }

  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = event => {
        if (event.data.size > 0) audioChunks.push(event.data);
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        audioChunks = [];

        const formData = new FormData();
        formData.append("audio", audioBlob, "recording.webm");

        // ‚úÖ Using your Vercel transcription endpoint
        const response = await fetch("https://habla-backend-git-main-tim-richardsons-projects.vercel.app/api/transcribe", {
          method: "POST",
          body: formData
        });

        const result = await response.json();
        if (result.text) {
          addMessage("user", result.text);
          sendToGPT(result.text);
        } else {
          alert("Transcription failed");
        }
      };

      mediaRecorder.start();
    } catch (err) {
      alert("Microphone access denied or unavailable.");
      console.error(err);
    }
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
    }
  }

  function toggleRecording() {
    if (!isRecording) {
      startRecording();
      isRecording = true;
      document.getElementById("micBtn").innerText = "üõë Stop";
    } else {
      stopRecording();
      isRecording = false;
      document.getElementById("micBtn").innerText = "üé§ Speak";
    }
  }

  async function sendToGPT(userText) {
    const apiKey = document.getElementById("apiKey").value;
    if (!apiKey) {
      alert("Please enter your OpenAI API key first.");
      return;
    }
    const mode = document.getElementById("mode").value;

    let systemPrompt = "You are a friendly Spanish tutor. Respond only in Spanish.";
    if (mode === "restaurant") systemPrompt = "Act as a waiter in a Spanish restaurant. Speak only Spanish.";
    if (mode === "hotel") systemPrompt = "Act as a receptionist in a Spanish hotel. Speak only Spanish.";
    if (mode === "airport") systemPrompt = "Act as an airport check-in staff in Spanish. Speak only Spanish.";

    try {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + apiKey
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages: [
            { role: "system", content: systemPrompt },
            { role: "user", content: userText }
          ]
        })
      });

      const data = await response.json();
      const aiText = data.choices[0].message.content;
      addMessage("ai", aiText);
      speak(aiText);
    } catch (err) {
      console.error(err);
      alert("Error contacting OpenAI.");
    }
  }

  function speak(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "es-ES";
    speechSynthesis.speak(utterance);
  }
  </script>
</body>
</html>
